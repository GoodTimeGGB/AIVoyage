/**
 * Êô∫Ë°åÈ∏øËíô - ‰∏ªÈ°µÈù¢
 * AIÈ©±Âä®ÁöÑÂÖ®ÈìæË∑ØÊô∫ËÉΩÂá∫Ë°åÂä©Êâã
 */
import common from '@ohos.app.ability.common'
import emitter from '@ohos.events.emitter'
import AMapView from '../components/AMapView'
import AMapBridge from '../common/AMapBridge'
import RoutePlanEngine, { RoutePlanResult } from '../engine/RoutePlanEngine'
import DialogEngine, { TravelIntent, ChatMessage } from '../engine/DialogEngine'
import WeatherService from '../service/WeatherService'
import POIService, { POIInfo } from '../service/POIService'
import { REROUTE_EVENT_ID, WEATHER_CHANGE_EVENT_ID } from '../service/RouteServiceAbility'

@Entry
@Component
struct Index {
  @State private query: string = ''
  @State private isLoading: boolean = false
  @State private serviceRunning: boolean = false
  @State private routeResult: RoutePlanResult | null = null
  @State private selectedRouteId: string = ''
  @State private chatMessages: ChatMessage[] = []
  @State private showPOIList: boolean = false
  @State private pois: POIInfo[] = []
  @State private weatherText: string = ''
  @State private trafficEnabled: boolean = false
  @State private showRouteOptions: boolean = false
  @State private alertMessage: string = ''
  @State private showAlert: boolean = false

  private engine: RoutePlanEngine = new RoutePlanEngine()
  private dialogEngine: DialogEngine = new DialogEngine()
  private weatherService: WeatherService = new WeatherService()
  private poiService: POIService = new POIService()

  aboutToAppear() {
    // ÁõëÂê¨ÈáçËßÑÂàí‰∫ã‰ª∂
    emitter.on({ eventId: REROUTE_EVENT_ID }, (eventData) => {
      this.handleRerouteEvent(eventData)
    })

    // ÁõëÂê¨Â§©Ê∞îÂèòÂåñ‰∫ã‰ª∂
    emitter.on({ eventId: WEATHER_CHANGE_EVENT_ID }, (eventData) => {
      this.handleWeatherEvent(eventData)
    })

    // ÂàùÂßãÂåñÂ§©Ê∞î
    this.loadWeather()
  }

  aboutToDisappear() {
    emitter.off(REROUTE_EVENT_ID)
    emitter.off(WEATHER_CHANGE_EVENT_ID)
  }

  /**
   * Âä†ËΩΩÂ§©Ê∞î‰ø°ÊÅØ
   */
  async loadWeather() {
    const result = await this.weatherService.getLiveWeather('110105')
    if (result.success && result.live) {
      this.weatherText = `${result.live.weather} ${result.live.temperature}‚ÑÉ`
    }
  }

  /**
   * Â§ÑÁêÜÁî®Êà∑ËæìÂÖ•
   */
  async handleSendMessage() {
    if (!this.query.trim() || this.isLoading) return

    this.isLoading = true
    const userInput = this.query
    this.query = ''

    try {
      // Ëß£ÊûêÁî®Êà∑ÊÑèÂõæ
      const intent = await this.dialogEngine.parseIntent(userInput)
      
      // Ê†πÊçÆÊÑèÂõæÊâßË°åÊìç‰Ωú
      await this.executeIntent(intent)
    } catch (e) {
      console.error(`Â§ÑÁêÜËæìÂÖ•Â§±Ë¥•: ${e}`)
      this.addAssistantMessage('Êä±Ê≠âÔºåÂ§ÑÁêÜÊÇ®ÁöÑËØ∑Ê±ÇÊó∂Âá∫Èîô‰∫ÜÔºåËØ∑ÈáçËØï„ÄÇ')
    } finally {
      this.isLoading = false
    }
  }

  /**
   * ÊâßË°åÁî®Êà∑ÊÑèÂõæ
   */
  async executeIntent(intent: TravelIntent) {
    switch (intent.action) {
      case 'plan_route':
        await this.planRoute(intent)
        break
      case 'search_poi':
        await this.searchPOI(intent)
        break
      case 'query_traffic':
        await this.queryTraffic()
        break
      case 'query_weather':
        await this.queryWeather()
        break
      default:
        const response = await this.dialogEngine.generateResponse(intent)
        this.addAssistantMessage(response)
    }
  }

  /**
   * ËßÑÂàíË∑ØÁ∫ø
   */
  async planRoute(intent: TravelIntent) {
    if (!intent.destination) {
      this.addAssistantMessage('ËØ∑ÂëäËØâÊàëÊÇ®ÊÉ≥ÂéªÂì™ÈáåÔºü')
      return
    }

    this.isLoading = true
    this.addAssistantMessage('Ê≠£Âú®‰∏∫ÊÇ®ËßÑÂàíË∑ØÁ∫ø...')

    try {
      const result = await this.engine.planRoute({
        origin: intent.origin || 'ÂΩìÂâç‰ΩçÁΩÆ',
        destination: intent.destination,
        time: intent.time,
        preferences: intent.preferences,
        mode: intent.mode || 'drive',
        considerTraffic: true,
        considerWeather: true,
        searchPOI: intent.preferences?.some(p => ['coffee_shop', 'gas_station', 'restaurant'].includes(p))
      })

      this.routeResult = result
      this.selectedRouteId = result.recommendedRouteId
      this.showRouteOptions = result.routes.length > 1

      // Âú®Âú∞Âõæ‰∏äÊòæÁ§∫Ë∑ØÁ∫ø
      AMapBridge.clearAll()
      
      if (result.routes.length > 1) {
        AMapBridge.drawMultipleRoutes(result.routes.map(r => ({
          id: r.id,
          points: r.points || [],
          isRecommended: r.id === result.recommendedRouteId
        })))
      } else if (result.routes[0]?.points) {
        AMapBridge.drawRoute(result.routes[0].points, {
          id: result.routes[0].id,
          isSelected: true
        })
      }

      // ÊòæÁ§∫POI
      if (result.pois && result.pois.length > 0) {
        this.pois = result.pois
        AMapBridge.addPOIMarkers(result.pois)
      }

      // ÁîüÊàêÂõûÂ§ç
      const response = await this.dialogEngine.generateResponse(intent, result)
      this.updateLastAssistantMessage(response)

      // Ë∞ÉÊï¥ËßÜÈáé
      if (result.routes[0]?.points) {
        AMapBridge.fitBounds(result.routes[0].points)
      }
    } catch (e) {
      this.updateLastAssistantMessage('Êä±Ê≠âÔºåË∑ØÁ∫øËßÑÂàíÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ')
    }
  }

  /**
   * ÊêúÁ¥¢POI
   */
  async searchPOI(intent: TravelIntent) {
    this.isLoading = true
    this.addAssistantMessage(`Ê≠£Âú®ÊêúÁ¥¢ÈôÑËøëÁöÑ${intent.poiKeyword || 'POI'}...`)

    try {
      const location = await AMapBridge.getCurrentLocation()
      if (!location) {
        this.updateLastAssistantMessage('Êó†Ê≥ïËé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ')
        return
      }

      const result = await this.poiService.searchByTypeName(
        intent.poiKeyword || '',
        location,
        3000
      )

      if (result.success && result.pois.length > 0) {
        this.pois = result.pois
        this.showPOIList = true
        AMapBridge.addPOIMarkers(result.pois.slice(0, 10))

        const response = await this.dialogEngine.generateResponse(intent, result)
        this.updateLastAssistantMessage(response)
      } else {
        this.updateLastAssistantMessage(`ÈôÑËøëÊú™ÊâæÂà∞${intent.poiKeyword || 'Áõ∏ÂÖ≥'}Âú∞ÁÇπ`)
      }
    } catch (e) {
      this.updateLastAssistantMessage('POIÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
    }
  }

  /**
   * Êü•ËØ¢Ë∑ØÂÜµ
   */
  async queryTraffic() {
    this.trafficEnabled = !this.trafficEnabled
    AMapBridge.setTrafficLayer(this.trafficEnabled)
    
    if (this.trafficEnabled) {
      this.addAssistantMessage('Â∑≤ÂºÄÂêØË∑ØÂÜµÂõæÂ±ÇÔºåÁªøËâ≤Ë°®Á§∫ÁïÖÈÄöÔºåÈªÑËâ≤Ë°®Á§∫ÁºìË°åÔºåÁ∫¢Ëâ≤Ë°®Á§∫Êã•Â†µ„ÄÇ')
    } else {
      this.addAssistantMessage('Â∑≤ÂÖ≥Èó≠Ë∑ØÂÜµÂõæÂ±Ç„ÄÇ')
    }
  }

  /**
   * Êü•ËØ¢Â§©Ê∞î
   */
  async queryWeather() {
    const result = await this.weatherService.getLiveWeather('110105')
    if (result.success && result.live) {
      const weather = result.live
      this.weatherText = `${weather.weather} ${weather.temperature}‚ÑÉ`
      this.addAssistantMessage(
        `ÂΩìÂâçÂ§©Ê∞îÔºö${weather.weather}ÔºåÊ∞îÊ∏©${weather.temperature}‚ÑÉÔºå` +
        `${weather.windDirection}È£é${weather.windPower}Á∫ßÔºåÊπøÂ∫¶${weather.humidity}%„ÄÇ` +
        (result.tips ? `Âá∫Ë°åÊèêÁ§∫Ôºö${result.tips}` : '')
      )
    } else {
      this.addAssistantMessage('Êó†Ê≥ïËé∑ÂèñÂ§©Ê∞î‰ø°ÊÅØ')
    }
  }

  /**
   * ÈÄâÊã©Ë∑ØÁ∫ø
   */
  selectRoute(routeId: string) {
    if (!this.routeResult) return

    this.selectedRouteId = routeId
    const route = this.routeResult.routes.find(r => r.id === routeId)
    
    if (route?.points) {
      AMapBridge.clearRoute()
      AMapBridge.drawRoute(route.points, {
        id: route.id,
        isSelected: true
      })

      const distKm = (route.distanceMeters / 1000).toFixed(1)
      const durMin = Math.round(route.durationSeconds / 60)
      this.addAssistantMessage(`Â∑≤ÂàáÊç¢Âà∞Ë∑ØÁ∫ø${routeId}ÔºåÂÖ®Á®ã${distKm}ÂÖ¨ÈáåÔºåÈ¢ÑËÆ°${durMin}ÂàÜÈíü„ÄÇ`)
    }
  }

  /**
   * ÂºÄÂßãÂØºËà™
   */
  startNavigation() {
    if (!this.routeResult) return

    const route = this.routeResult.routes.find(r => r.id === this.selectedRouteId)
    if (route?.points) {
      // ÂêØÂä®ÂêéÂè∞ÊúçÂä°
      const ctx = (globalThis as any).abilityContext as common.UIAbilityContext
      ctx.startServiceAbility({
        bundleName: 'com.personalproject.zhixinghongmeng',
        abilityName: 'RouteServiceAbility',
        parameters: {
          action: 'start_navigation',
          destination: this.routeResult.routes[0]?.steps?.[0]?.instruction || 'ÁõÆÁöÑÂú∞',
          routePoints: route.points
        }
      })

      this.serviceRunning = true
      AMapBridge.startNavigation(route.points)
      this.addAssistantMessage('ÂØºËà™Â∑≤ÂêØÂä®ÔºåÁ•ÅÊÇ®‰∏ÄË∑ØÂπ≥ÂÆâÔºÅ')
    }
  }

  /**
   * ÂÅúÊ≠¢ÂØºËà™
   */
  stopNavigation() {
    const ctx = (globalThis as any).abilityContext as common.UIAbilityContext
    ctx.stopServiceAbility({
      bundleName: 'com.personalproject.zhixinghongmeng',
      abilityName: 'RouteServiceAbility'
    })

    this.serviceRunning = false
    AMapBridge.stopNavigation()
    this.addAssistantMessage('ÂØºËà™Â∑≤ÁªìÊùü„ÄÇ')
  }

  /**
   * Â§ÑÁêÜÈáçËßÑÂàí‰∫ã‰ª∂
   */
  handleRerouteEvent(eventData: any) {
    try {
      const reason = eventData?.data?.reason || 'ÂèëÁé∞Êõ¥‰ºòË∑ØÁ∫ø'
      const timeSaved = eventData?.data?.timeSaved || 0
      
      this.alertMessage = `${reason}ÔºåÂèØËäÇÁúÅ${timeSaved}ÂàÜÈíüÔºåÊòØÂê¶ÂàáÊç¢Ôºü`
      this.showAlert = true
    } catch (e) {
      console.error(`Â§ÑÁêÜÈáçËßÑÂàí‰∫ã‰ª∂Â§±Ë¥•: ${e}`)
    }
  }

  /**
   * Â§ÑÁêÜÂ§©Ê∞îÂèòÂåñ‰∫ã‰ª∂
   */
  handleWeatherEvent(eventData: any) {
    try {
      const weather = JSON.parse(eventData?.data?.weather || '{}')
      if (weather.weather) {
        this.weatherText = `${weather.weather} ${weather.temperature}‚ÑÉ`
        this.addAssistantMessage(`Â§©Ê∞îÂèòÂåñÔºö${weather.weather}ÔºåËØ∑Ê≥®ÊÑèÂÆâÂÖ®„ÄÇ`)
      }
    } catch (e) {
      console.error(`Â§ÑÁêÜÂ§©Ê∞î‰∫ã‰ª∂Â§±Ë¥•: ${e}`)
    }
  }

  /**
   * Ê∑ªÂä†Âä©ÊâãÊ∂àÊÅØ
   */
  addAssistantMessage(content: string) {
    this.chatMessages = [...this.chatMessages, {
      role: 'assistant',
      content,
      timestamp: Date.now()
    }]
  }

  /**
   * Êõ¥Êñ∞ÊúÄÂêé‰∏ÄÊù°Âä©ÊâãÊ∂àÊÅØ
   */
  updateLastAssistantMessage(content: string) {
    if (this.chatMessages.length > 0) {
      const lastIdx = this.chatMessages.length - 1
      if (this.chatMessages[lastIdx].role === 'assistant') {
        this.chatMessages[lastIdx] = {
          ...this.chatMessages[lastIdx],
          content
        }
        this.chatMessages = [...this.chatMessages]
      } else {
        this.addAssistantMessage(content)
      }
    } else {
      this.addAssistantMessage(content)
    }
  }

  build() {
    Stack() {
      // Âú∞ÂõæÂ±Ç
      AMapView()

      // ‰∏ªÁïåÈù¢Â±Ç
      Column() {
        // È°∂ÈÉ®Â§©Ê∞îÊ†è
        if (this.weatherText) {
          Row() {
            Text('‚òÄÔ∏è ' + this.weatherText)
              .fontSize(14)
              .fontColor('#666')
          }
          .width('100%')
          .justifyContent(FlexAlign.End)
          .padding({ right: 16, top: 8 })
        }

        // ËæìÂÖ•Âå∫Âüü
        Row() {
          TextInput({ placeholder: 'ËØ¥Âá∫ÊÇ®ÁöÑÂá∫Ë°åÈúÄÊ±Ç...' })
            .onChange((v: string) => {
              this.query = v
            })
            .onSubmit(() => {
              this.handleSendMessage()
            })
            .width('60%')
            .height(40)
          
          Button('üé§')
            .onClick(() => {
              // TODO: ËØ≠Èü≥ËØÜÂà´
              console.info('ÂêØÂä®ËØ≠Èü≥ËØÜÂà´')
            })
            .width(40)
            .height(40)
            .margin({ left: 8 })
          
          Button(this.isLoading ? '‚Ä¢‚Ä¢‚Ä¢' : 'ÂèëÈÄÅ')
            .onClick(() => {
              this.handleSendMessage()
            })
            .width(60)
            .height(40)
            .margin({ left: 8 })
            .enabled(!this.isLoading)
        }
        .width('100%')
        .backgroundColor('#ffffff')
        .opacity(0.95)
        .padding(12)
        .borderRadius(8)
        .margin({ top: 8 })

        // ÂØπËØùÂéÜÂè≤
        if (this.chatMessages.length > 0) {
          Scroll() {
            Column() {
              ForEach(this.chatMessages.slice(-5), (msg: ChatMessage, index: number) => {
                Row() {
                  Text(msg.content)
                    .fontSize(14)
                    .fontColor(msg.role === 'assistant' ? '#333' : '#666')
                    .maxLines(3)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
                .width('100%')
                .padding(8)
                .backgroundColor(msg.role === 'assistant' ? '#e8f4fd' : '#f5f5f5')
                .borderRadius(8)
                .margin({ bottom: 4 })
              })
            }
          }
          .height(150)
          .width('100%')
          .backgroundColor('rgba(255,255,255,0.9)')
          .borderRadius(8)
          .margin({ top: 8 })
          .padding(8)
        }

        // Ë∑ØÁ∫øÈÄâÈ°π
        if (this.showRouteOptions && this.routeResult) {
          Row() {
            ForEach(this.routeResult.routes, (route, index: number) => {
              Button({
                type: this.selectedRouteId === route.id ? ButtonType.Normal : ButtonType.Normal
              }) {
                Column() {
                  Text(`Ë∑ØÁ∫ø${index + 1}`).fontSize(12)
                  Text(`${Math.round(route.durationSeconds / 60)}ÂàÜÈíü`).fontSize(10)
                }
              }
              .backgroundColor(this.selectedRouteId === route.id ? '#3366FF' : '#e0e0e0')
              .fontColor(this.selectedRouteId === route.id ? '#fff' : '#333')
              .onClick(() => this.selectRoute(route.id))
              .margin({ right: 8 })
              .padding(8)
              .borderRadius(8)
            })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding(8)
          .backgroundColor('rgba(255,255,255,0.9)')
          .borderRadius(8)
          .margin({ top: 8 })
        }

        // Â∫ïÈÉ®Êìç‰ΩúÊ†è
        Blank()

        Row() {
          if (this.routeResult && !this.serviceRunning) {
            Button('ÂºÄÂßãÂØºËà™')
              .onClick(() => this.startNavigation())
              .backgroundColor('#3366FF')
              .fontColor('#fff')
              .width('45%')
          }

          if (this.serviceRunning) {
            Button('ÁªìÊùüÂØºËà™')
              .onClick(() => this.stopNavigation())
              .backgroundColor('#ff4444')
              .fontColor('#fff')
              .width('45%')
          }

          Button(this.trafficEnabled ? 'ÂÖ≥Èó≠Ë∑ØÂÜµ' : 'ÊòæÁ§∫Ë∑ØÂÜµ')
            .onClick(() => this.queryTraffic())
            .backgroundColor('#f0f0f0')
            .fontColor('#333')
            .width('45%')
            .margin({ left: 8 })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .padding(12)
        .backgroundColor('#ffffff')
      }
      .width('100%')
      .height('100%')
      .padding({ left: 16, right: 16 })
      .justifyContent(FlexAlign.Start)

      // ÊèêÁ§∫ÂºπÁ™ó
      if (this.showAlert) {
        Column() {
          Text(this.alertMessage)
            .fontSize(14)
            .margin({ bottom: 16 })
          
          Row() {
            Button('ÂøΩÁï•')
              .onClick(() => {
                this.showAlert = false
              })
              .backgroundColor('#e0e0e0')
              .margin({ right: 16 })
            
            Button('ÂàáÊç¢Ë∑ØÁ∫ø')
              .onClick(() => {
                this.showAlert = false
                // TODO: ÂàáÊç¢Âà∞Êñ∞Ë∑ØÁ∫ø
              })
              .backgroundColor('#3366FF')
              .fontColor('#fff')
          }
        }
        .width('80%')
        .padding(20)
        .backgroundColor('#fff')
        .borderRadius(12)
        .shadow({ radius: 10, color: 'rgba(0,0,0,0.2)' })
      }
    }
    .width('100%')
    .height('100%')
  }
}
